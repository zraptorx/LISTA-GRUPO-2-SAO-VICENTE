<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Lista de PresenÃ§a â€“ Grupo 2 SÃ£o Vicente</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:12px; }
  h1 { text-align:center; margin:6px 0 4px; }
  .sub { text-align:center; color:#555; margin:0 0 10px; }

  .bar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; margin: 8px 0 10px; }
  .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; background:#eee; }
  .ok { background:#e8fff1; color:#0b7; border:1px solid #bff0d2; }
  .warn { background:#fff7e6; color:#b70; border:1px solid #ffe1a8; }
  .bad { background:#ffefef; color:#b00; border:1px solid #ffd2d2; }

  .controls { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; justify-content:center; }
  .controls input, .controls button { padding:9px 10px; font-size:14px; border-radius:10px; border:1px solid #ddd; }
  .controls button { cursor:pointer; background:#fff; }
  .primary { background:#1a73e8; color:#fff; border:none; }
  .danger { background:#c62828; color:#fff; border:none; }

  .wrap { overflow-x:auto; border:1px solid #e8e8e8; border-radius:12px; background:#fff; }
  table { border-collapse:collapse; width:max-content; min-width: 980px; background:#fff; table-layout: auto; }
  th, td { border:1px solid #ddd; padding:6px 8px; text-align:center; vertical-align:middle; }
  th { position: sticky; top:0; background:#f5f5f5; z-index: 3; }

  th.name, td.name {
    position: sticky;
    left: 0;
    background: #fff;
    z-index: 5;
    text-align: left;
    font-weight: 700;
    min-width: 280px;
    max-width: 360px;
    white-space: normal;
    word-break: break-word;
    line-height: 1.2;
  }
  th.name { background:#f5f5f5; z-index: 6; }

  th.day { min-width: 38px; font-size: 13px; }
  td input { width: 18px; height: 18px; }

  .remove-btn { background:#c62828; color:#fff; border:none; padding:6px 8px; cursor:pointer; border-radius:10px; }
  .footer { text-align:center; font-size:12px; color:#666; margin-top:10px; }

  .errorBox { display:none; margin:10px auto 0; max-width:980px; padding:10px; border-radius:12px;
              border:1px solid #ffd2d2; background:#ffefef; color:#900; white-space:pre-wrap; }
</style>
</head>

<body>
  <h1>Lista de PresenÃ§a â€“ Grupo 2</h1>
  <p class="sub" id="monthLabel">â€”</p>

  <div class="bar">
    <span class="pill warn" id="status">Conectandoâ€¦</span>
    <span class="pill" id="proj">Project: â€”</span>
    <span class="pill" id="docid">Doc: â€”</span>
    <span class="pill" id="uid">uid: â€”</span>
    <span class="pill" id="updated">updatedAt: â€”</span>
  </div>

  <div class="controls">
    <input id="newName" placeholder="Adicionar novo nome">
    <button class="primary" onclick="addPerson()">Adicionar</button>
    <button onclick="copyReport()">Copiar relatÃ³rio (hoje)</button>
    <button class="danger" onclick="testSync()">Testar sincronizaÃ§Ã£o</button>
  </div>

  <div id="errorBox" class="errorBox"></div>

  <div class="wrap">
    <table id="table"></table>
  </div>

  <div class="footer">
    Firebase â€¢ Login anÃ´nimo â€¢ SincronizaÃ§Ã£o em tempo real â€¢ (MÃªs/Ano automÃ¡tico)
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, updateDoc, onSnapshot, deleteField,
    serverTimestamp, getDoc
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCM0nYBjOaHWKVjUm6PPpPjQ2MdAiqil0s",
    authDomain: "lista-grupo-2-sao-vicente.firebaseapp.com",
    projectId: "lista-grupo-2-sao-vicente",
    storageBucket: "lista-grupo-2-sao-vicente.firebasestorage.app",
    messagingSenderId: "95897300612",
    appId: "1:95897300612:web:e18378220805a70061dcd1"
  };

  const statusEl = document.getElementById("status");
  const projEl = document.getElementById("proj");
  const docEl = document.getElementById("docid");
  const uidEl = document.getElementById("uid");
  const updEl = document.getElementById("updated");
  const errorBox = document.getElementById("errorBox");

  function setStatus(text, cls){ statusEl.textContent=text; statusEl.className="pill "+cls; }
  function showError(msg){ errorBox.style.display="block"; errorBox.textContent=msg; setStatus("Erro","bad"); }
  function clearError(){ errorBox.style.display="none"; errorBox.textContent=""; }

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  projEl.textContent = "Project: " + firebaseConfig.projectId;

  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth()+1).padStart(2,"0");
  const monthId = `${year}-${month}`;
  const daysInMonth = new Date(year, Number(month), 0).getDate();

  document.getElementById("monthLabel").innerText =
    now.toLocaleDateString("pt-BR", { month:"long", year:"numeric" });

  docEl.textContent = "Doc: presencas_g2/" + monthId;
  const docRef = doc(db, "presencas_g2", monthId);

  const defaultNames = [
    "DEBORA MARGARETE C. SANTOS","AGUINALDO BARBOSA","ANNA AMÃ‰LIA S. CAMARGO",
    "CAMILA CRISTINE DOS SANTOS","CAMILA VENTURA SIMÃƒO MACEDO","CARLA BEATRICE FERREIRA PINTO",
    "CASSIUS CLAY MACEDO","GABRIEL SOUZA DOS SANTOS","GABRIELA RICARTE SANTOS","GLEISON CORREIA",
    "JORGE NICOLÃS PEREDO PINTO","JOSEFA MARIA DE JESUS CAMPOS","JOSÃ‰ CARLOS MENEZES SANTOS",
    "JOÃƒO HENRIQUE M. S. CORREIA","KALEU DA SILVA OLIVEIRA","KARINA S. O. PEDRINI",
    "LUDMILA MATHIAS","NIVALDO DE JESUS SOARES","PATRÃCIA SANTOS DE LIMA",
    "RACHEL RICARTE FREITAS","ROMULO PEREDO MURTHA","SAMUEL CARLOS G. M. MENEZES",
    "SOFIA JESUS DOS SANTOS","VALENTINA PEREDO PINTO","VERA LUCIA CONCEIÃ‡ÃƒO SANTOS",
    "WALTER CAMPOS FERREIRA","WILLIAN JESUS SANTOS","YASMIN FERREIRA VIEIRA SOARES",
    "ANDREIA SILVA GONÃ‡ALVES","CILENE CRISTINA S. BARBOSA","GILBERTO DOS SANTOS"
  ];

  const table = document.getElementById("table");

  function render(data){
    const names = (data?.names || []).slice().sort((a,b)=>a.localeCompare(b,"pt-BR"));
    const marks = data?.marks || {};
    const t = data?.updatedAt?.toDate ? data.updatedAt.toDate() : null;
    updEl.textContent = "updatedAt: " + (t ? t.toLocaleString("pt-BR") : "â€”");

    table.innerHTML = "";
    let header = "<tr><th class='name'>Nome</th>";
    for(let d=1; d<=daysInMonth; d++) header+=`<th class="day">${d}</th>`;
    header+="<th>Remover</th></tr>";
    table.innerHTML+=header;

    for(const name of names){
      let row = `<tr><td class="name">${name}</td>`;
      for(let d=1; d<=daysInMonth; d++){
        const checked = marks?.[String(d)]?.[name] ? "checked" : "";
        row += `<td><input type="checkbox" ${checked}
          onchange="setMark(${d}, ${JSON.stringify(name)}, this.checked)"></td>`;
      }
      row += `<td><button class="remove-btn" onclick="removePerson(${JSON.stringify(name)})">X</button></td></tr>`;
      table.innerHTML += row;
    }
  }

  window.setMark = async (day, name, value) => {
    try{
      clearError();
      await updateDoc(docRef, {
        [`marks.${String(day)}.${name}`]: value,
        updatedAt: serverTimestamp()
      });
    }catch(e){
      showError("Falha ao gravar no Firestore:\n\n" + (e?.message || e));
    }
  };

  window.addPerson = async () => {
    const input = document.getElementById("newName");
    const name = (input.value || "").trim().toUpperCase();
    if(!name) return;
    try{
      clearError();
      const snap = await getDoc(docRef);
      const cur = snap.data()?.names || defaultNames;
      const next = Array.from(new Set([...cur, name]));
      await updateDoc(docRef, { names: next, updatedAt: serverTimestamp() });
      input.value = "";
    }catch(e){
      showError("Falha ao adicionar nome:\n\n" + (e?.message || e));
    }
  };

  window.removePerson = async (name) => {
    if(!confirm("Excluir o nome para TODOS?\n\n" + name)) return;
    try{
      clearError();
      const snap = await getDoc(docRef);
      const cur = snap.data()?.names || [];
      const next = cur.filter(n => n !== name);
      await updateDoc(docRef, { names: next, updatedAt: serverTimestamp() });
      const updates = {};
      for(let d=1; d<=daysInMonth; d++){
        updates[`marks.${String(d)}.${name}`] = deleteField();
      }
      updates["updatedAt"] = serverTimestamp();
      await updateDoc(docRef, updates);
    }catch(e){
      showError("Falha ao remover nome:\n\n" + (e?.message || e));
    }
  };

  window.copyReport = async () => {
    try{
      clearError();
      const snap = await getDoc(docRef);
      const data = snap.data() || {};
      const names = (data.names || []).slice().sort((a,b)=>a.localeCompare(b,"pt-BR"));
      const marks = data.marks || {};
      const today = new Date();
      const d = String(today.getDate());
      const m = String(today.getMonth()+1).padStart(2,"0");
      const y = today.getFullYear();
      const presentes = names.filter(n => marks?.[d]?.[n]);
      const txt = `ðŸ“‹ G2 â€” PresenÃ§a (${d}/${m}/${y})\nTotal: ${presentes.length}\n\n` +
                  presentes.map((n,i)=>`${i+1}. ${n}`).join("\n");
      await navigator.clipboard.writeText(txt);
      alert("RelatÃ³rio copiado! Cole no WhatsApp.");
    }catch(e){
      showError("Falha ao gerar/copiar relatÃ³rio:\n\n" + (e?.message || e));
    }
  };

  window.testSync = async () => {
    try{
      clearError();
      await updateDoc(docRef, { testPing: Math.random().toString(36).slice(2,8), updatedAt: serverTimestamp() });
      alert("OK! Consegui escrever no Firestore. Abra em outro celular para ver atualizar sozinho.");
    }catch(e){
      showError("TESTE FALHOU:\n\n" + (e?.message || e));
      alert("Falhou. Veja a mensagem em vermelho.");
    }
  };

  onAuthStateChanged(auth, (user) => {
    if(user){
      uidEl.textContent = "uid: " + user.uid;
      setStatus("Conectado","ok");
    }else{
      uidEl.textContent = "uid: â€”";
      setStatus("Conectandoâ€¦","warn");
    }
  });

  try{
    await signInAnonymously(auth);
    await setDoc(docRef, { names: defaultNames, marks: {}, updatedAt: serverTimestamp() }, { merge: true });
    onSnapshot(docRef,
      (snap) => { if(snap.exists()) render(snap.data()); },
      (err) => showError("Sem permissÃ£o para LER o Firestore:\n\n" + (err?.message || err))
    );
    setStatus("Conectado","ok");
  }catch(e){
    showError("Erro ao inicializar:\n\n" + (e?.message || e) +
      "\n\nConfira DomÃ­nios autorizados (zraptorx.github.io) e Regras do Firestore.");
  }
</script>

</body>
</html>
