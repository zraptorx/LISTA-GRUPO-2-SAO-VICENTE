<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chamada Mensal - G2 (Sincronizado)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#fff;color:#111}
    h1{font-size:20px;margin:0 0 6px 0}
    .muted{color:#666;font-size:12px;margin-bottom:10px}
    button,select,input,textarea{
      padding:10px;font-size:15px;border-radius:8px;border:1px solid #ccc;margin:4px 0;background:#fff;
    }
    button{cursor:pointer}
    button.primary{border-color:#111}
    button.danger{border-color:#a33;color:#a33}
    button.gray{border-color:#777;color:#333}
    .topbar{
      display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;
      padding:12px;border:1px solid #ddd;border-radius:12px;background:#fafafa;margin:12px 0;
    }
    .field{display:flex;flex-direction:column;gap:6px}
    .box{border:1px solid #ddd;border-radius:12px;padding:12px;background:#fff;margin-top:12px;}
    textarea{width:100%;min-height:130px;resize:vertical}
    .small{font-size:12px;color:#666}

    /* Tabela / rolagem */
    .tableWrap{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border:1px solid #ddd;
      border-radius:12px;
      background:#fff;
    }
    table{
      border-collapse:collapse;
      width:max-content;
      min-width:100%;
      margin-top:0;
    }
    th,td{border:1px solid #ddd;padding:6px;text-align:center;white-space:nowrap}
    th{
      background:#f2f2f2;
      font-size:12px;
      position:sticky;top:0;z-index:3;
    }
    th.nameHead, td.name{
      position:sticky;left:0;z-index:4;background:#fff;text-align:left;min-width:260px;max-width:260px;
      border-right:2px solid #ddd;
    }
    th.nameHead{background:#f2f2f2;z-index:5}
    td.name{font-weight:600}
    td.day{min-width:38px}
    .present{background:#d1f3dc}

    .statusLine{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;
      padding:10px 12px;border:1px solid #ddd;border-radius:12px;background:#fff;
    }
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .dot.ok{background:#16a34a}
    .dot.wait{background:#f59e0b}
    .dot.bad{background:#dc2626}

    /* Domingo: cabe√ßalhos compactos */
    th .sub{display:block;font-size:10px;color:#444;margin-top:2px}

    @media (max-width: 640px){
      th.nameHead, td.name{min-width:220px;max-width:220px;}
    }
  </style>
</head>
<body>

<h1>üìã Lista de Presen√ßa ‚Äì G2 (Sincronizado)</h1>
<div class="muted">
  Agora as marca√ß√µes ficam <b>iguais para todos</b> (celular/computador/colaboradores), usando Firebase.
  <br><span class="small">Domingos: duas marca√ß√µes (EBD e Culto). PDF: relat√≥rio mensal.</span>
</div>

<div class="statusLine" id="statusLine">
  <span><span class="dot wait" id="dot"></span><b id="statusText">Conectando‚Ä¶</b></span>
  <span class="small" id="statusDetail">Aguardando configura√ß√£o do Firebase.</span>
</div>

<div class="topbar">
  <div class="field">
    <div class="small">M√™s</div>
    <select id="month"></select>
  </div>

  <div class="field">
    <div class="small">Ano</div>
    <select id="year"></select>
  </div>

  <div class="field">
    <div class="small">Dia (relat√≥rio WhatsApp)</div>
    <select id="daySelect"></select>
  </div>

  <div class="field" style="flex:1;min-width:220px">
    <div class="small">Buscar (filtra a lista)</div>
    <input id="search" type="text" placeholder="Digite parte do nome..." />
  </div>

  <div class="field">
    <div class="small">&nbsp;</div>
    <button id="btnGenerate" class="primary">Gerar texto do dia</button>
  </div>

  <div class="field">
    <div class="small">&nbsp;</div>
    <button id="btnCopy" class="primary">Copiar para WhatsApp</button>
  </div>

  <div class="field">
    <div class="small">&nbsp;</div>
    <button id="btnPdf" class="primary">Gerar PDF do m√™s</button>
  </div>

  <div class="field">
    <div class="small">&nbsp;</div>
    <button id="btnClearDay" class="danger">Limpar dia</button>
  </div>

  <div class="field">
    <div class="small">&nbsp;</div>
    <button id="btnForceReload" class="gray">Recarregar</button>
  </div>
</div>

<div class="tableWrap">
  <table id="table"></table>
</div>

<div class="box">
  <div class="small" style="margin-bottom:6px;">Texto pronto para compartilhar no WhatsApp</div>
  <textarea id="waText" readonly></textarea>
  <div class="small" style="margin-top:8px;">Dica: clique em ‚ÄúCopiar‚Äù e cole no grupo/conversa.</div>
</div>

<!-- jsPDF (PDF no navegador) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script type="module">
  // ========= Firebase CONFIG (J√Å PRONTO) =========
  const firebaseConfig = {
    apiKey: "AIzaSyCM0nYBjOaHWKVjUm6PPpPjQ2MdAiqil0s",
    authDomain: "lista-grupo-2-sao-vicente.firebaseapp.com",
    projectId: "lista-grupo-2-sao-vicente",
    storageBucket: "lista-grupo-2-sao-vicente.appspot.com",
    messagingSenderId: "95897300612",
    appId: "1:95897300612:web:e18378220805a70061dcd1"
  };
  // ==============================================

  // Firebase SDK (modular) - N√ÉO MISTURE VERS√ïES
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteField
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ====== LISTA (G2) ======
  const pessoas = [
    "DEBORA MARGARETE C. SANTOS","AGUINALDO BARBOSA","ANNA AM√âLIA S. CAMARGO",
    "CAMILA CRISTINE DOS SANTOS","CAMILA VENTURA SIM√ÉO MACEDO","CARLA BEATRICE FERREIRA PINTO",
    "CASSIUS CLAY MACEDO","GABRIEL SOUZA DOS SANTOS","GABRIELA RICARTE SANTOS",
    "GLEISON CORREIA","JORGE NICOL√ÅS PEREDO PINTO","JOSEFA MARIA DE JESUS CAMPOS",
    "JOS√â CARLOS MENEZES SANTOS","JO√ÉO HENRIQUE M. S. CORREIA","KALEU DA SILVA OLIVEIRA",
    "KARINA S. O. PEDRINI","LUDMILA MATHIAS","NIVALDO DE JESUS SOARES",
    "PATR√çCIA SANTOS DE LIMA","RACHEL RICARTE FREITAS","ROMULO PEREDO MURTHA",
    "SAMUEL CARLOS G. M. MENEZES","SOFIA JESUS DOS SANTOS","VALENTINA PEREDO PINTO",
    "VERA LUCIA CONCEI√á√ÉO SANTOS","WALTER CAMPOS FERREIRA","WILLIAN JESUS SANTOS",
    "YASMIN FERREIRA VIEIRA SOARES","ANDREIA SILVA GON√áALVES",
    "CILENE CRISTINA S. BARBOSA","GILBERTO DOS SANTOS"
  ];

  // ====== UI ======
  const monthSel = document.getElementById("month");
  const yearSel  = document.getElementById("year");
  const daySel   = document.getElementById("daySelect");
  const table    = document.getElementById("table");
  const searchEl = document.getElementById("search");
  const waText   = document.getElementById("waText");
  const dot = document.getElementById("dot");
  const statusText = document.getElementById("statusText");
  const statusDetail = document.getElementById("statusDetail");

  const months = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

  months.forEach((m,i)=>{
    const o=document.createElement("option");
    o.value=i; o.text=m;
    monthSel.appendChild(o);
  });

  const now = new Date();
  monthSel.value = now.getMonth();

  for(let y=now.getFullYear()-1; y<=now.getFullYear()+2; y++){
    const o=document.createElement("option");
    o.value=y; o.text=y;
    yearSel.appendChild(o);
  }
  yearSel.value = now.getFullYear();

  function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
  function isSunday(y, mZeroBased, d){ return new Date(y, mZeroBased, d).getDay() === 0; } // 0 = domingo

  function monthKey(){
    const y = yearSel.value;
    const m = String(Number(monthSel.value)+1).padStart(2,"0");
    return y + "-" + m; // ex.: 2025-12
  }

  function refreshDaySelect(){
    const y = Number(yearSel.value);
    const m = Number(monthSel.value);
    const days = daysInMonth(y, m);

    const keep = Number(daySel.value || 1);
    daySel.innerHTML = "";
    for(let d=1; d<=days; d++){
      const o=document.createElement("option");
      o.value=d;
      o.text = isSunday(y,m,d) ? `${d} (Dom)` : `${d}`;
      daySel.appendChild(o);
    }
    daySel.value = (keep>=1 && keep<=days) ? String(keep) : "1";
  }

  function normalize(s){
    return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  }
  function getFilteredIndexes(){
    const q = normalize(searchEl.value.trim());
    if(!q) return pessoas.map((_,i)=>i);
    const idx=[];
    pessoas.forEach((nome,i)=>{
      if(normalize(nome).includes(q)) idx.push(i);
    });
    return idx;
  }

  // ====== Colunas (Domingo = 2 colunas: EBD e Culto) ======
  // Cada coluna: { d: number, type: "C"|"E", label: string, sub?: string }
  function buildColumns(){
    const y = Number(yearSel.value);
    const m = Number(monthSel.value);
    const days = daysInMonth(y, m);
    const cols = [];
    for(let d=1; d<=days; d++){
      if(isSunday(y,m,d)){
        cols.push({ d, type:"E", label: String(d), sub: "EBD" });   // manh√£
        cols.push({ d, type:"C", label: String(d), sub: "Culto" }); // noite
      }else{
        cols.push({ d, type:"C", label: String(d) });
      }
    }
    return cols;
  }

  // ====== Firebase state ======
  let app, auth, db;
  let unsubscribe = null;
  let currentDocRef = null;

  // Cache local do m√™s atual (vem do Firestore)
  // Estrutura: marks["i-d-T"] = true  (T = "C" culto | "E" ebd)
  let marks = {};

  function setStatus(kind, text, detail){
    dot.className = "dot " + (kind === "ok" ? "ok" : kind === "bad" ? "bad" : "wait");
    statusText.textContent = text;
    statusDetail.textContent = detail || "";
  }

  function isConfigured(){
    return firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "COLE_AQUI";
  }

  async function initFirebase(){
    if(!isConfigured()){
      setStatus("bad","Firebase n√£o configurado","Cole o firebaseConfig no topo do arquivo e publique novamente.");
      return;
    }

    try{
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);

      setStatus("wait","Autenticando‚Ä¶","Entrando de forma an√¥nima para permitir sincroniza√ß√£o.");

      await signInAnonymously(auth);

      onAuthStateChanged(auth, (user)=>{
        if(user){
          setStatus("ok","Conectado","Sincronizando com Firestore.");
          attachMonthListener();
        }else{
          setStatus("wait","Desconectado","Reconectando‚Ä¶");
        }
      });

    }catch(e){
      console.error(e);
      setStatus("bad","Erro ao conectar","Verifique firebaseConfig, Auth an√¥nimo e Firestore.");
    }
  }

  async function ensureDocExists(ref){
    await setDoc(ref, { marks: {} }, { merge: true });
  }

  function attachMonthListener(){
    if(unsubscribe) unsubscribe();

    const key = monthKey();
    currentDocRef = doc(db, "presencas_g2", key);

    ensureDocExists(currentDocRef).then(()=>{}).catch(()=>{});

    unsubscribe = onSnapshot(currentDocRef, (snap)=>{
      const data = snap.data() || {};
      marks = (data.marks || {});
      render();
      generateWhatsAppText();
    }, (err)=>{
      console.error(err);
      setStatus("bad","Sem acesso ao Firestore","Confira as regras do Firestore.");
    });
  }

  function markKey(i, d, type){ return `${i}-${d}-${type}`; }

  async function toggleMark(i, d, type){
    if(!currentDocRef){
      alert("Ainda conectando‚Ä¶");
      return;
    }
    const k = markKey(i,d,type);
    const fieldPath = "marks." + k;

    try{
      if(marks[k]){
        await updateDoc(currentDocRef, { [fieldPath]: deleteField() });
      }else{
        await updateDoc(currentDocRef, { [fieldPath]: true });
      }
    }catch(e){
      console.error(e);
      alert("Falha ao salvar. Verifique conex√£o/regras do Firestore.");
    }
  }

  async function clearSelectedDay(){
    const d = Number(daySel.value || 1);
    const y = Number(yearSel.value);
    const m = Number(monthSel.value);

    if(!confirm("Confirma limpar as presen√ßas do dia " + d + " para TODOS?")) return;
    if(!currentDocRef){ alert("Ainda conectando‚Ä¶"); return; }

    try{
      const patch = {};
      const sunday = isSunday(y,m,d);

      for(let i=0;i<pessoas.length;i++){
        // culto sempre existe
        const kc = markKey(i,d,"C");
        if(marks[kc]) patch["marks." + kc] = deleteField();

        // EBD s√≥ domingo
        if(sunday){
          const ke = markKey(i,d,"E");
          if(marks[ke]) patch["marks." + ke] = deleteField();
        }
      }

      if(Object.keys(patch).length === 0) return;
      await updateDoc(currentDocRef, patch);
    }catch(e){
      console.error(e);
      alert("Falha ao limpar o dia. Verifique conex√£o/regras.");
    }
  }

  function render(){
    const y = Number(yearSel.value);
    const m = Number(monthSel.value);

    refreshDaySelect();
    const visible = getFilteredIndexes();
    const cols = buildColumns();

    // Header
    let html = "<tr><th class='nameHead'>Nome</th>";
    for(const c of cols){
      if(c.sub){
        html += `<th>${c.label}<span class="sub">${c.sub}</span></th>`;
      }else{
        html += `<th>${c.label}</th>`;
      }
    }
    html += "</tr>";

    // Rows
    visible.forEach((i)=>{
      const nome = pessoas[i];
      html += "<tr><td class='name'>" + nome + "</td>";
      for(const c of cols){
        const k = markKey(i, c.d, c.type);
        const mark = !!marks[k];
        html += "<td class='day " + (mark ? "present" : "") + "' data-i='"+i+"' data-d='"+c.d+"' data-t='"+c.type+"'>" + (mark ? "‚úì" : "") + "</td>";
      }
      html += "</tr>";
    });

    table.innerHTML = html;

    // Click handler (event delegation)
    table.querySelectorAll("td.day").forEach(td=>{
      td.addEventListener("click", ()=>{
        const i = Number(td.getAttribute("data-i"));
        const d = Number(td.getAttribute("data-d"));
        const t = td.getAttribute("data-t");
        toggleMark(i, d, t);
      });
    });
  }

  function getPresentNamesForDay(d, type){
    const presentes = [];
    for(let i=0; i<pessoas.length; i++){
      if(marks[markKey(i,d,type)]) presentes.push(pessoas[i]);
    }
    presentes.sort((a,b)=>a.localeCompare(b,"pt-BR"));
    return presentes;
  }

  function generateWhatsAppText(){
    const d = Number(daySel.value || 1);
    const y = Number(yearSel.value);
    const mZero = Number(monthSel.value);
    const m = mZero + 1;

    const dd = String(d).padStart(2,"0");
    const mm = String(m).padStart(2,"0");
    const sunday = isSunday(y,mZero,d);

    if(!sunday){
      const presentes = getPresentNamesForDay(d, "C");
      if(presentes.length === 0){
        waText.value = `üìã G2 ‚Äî Presen√ßa (${dd}/${mm}/${y})\n\nNenhuma presen√ßa marcada.`;
        return;
      }
      const linhas = presentes.map((nome, idx)=> (idx+1) + ". " + nome).join("\n");
      waText.value =
        `üìã G2 ‚Äî Presen√ßa (${dd}/${mm}/${y})\n` +
        `Total: ${presentes.length}\n\n` +
        linhas;
      return;
    }

    // Domingo: EBD + Culto
    const ebd = getPresentNamesForDay(d, "E");
    const culto = getPresentNamesForDay(d, "C");

    const ebdTxt = (ebd.length === 0)
      ? "Nenhuma presen√ßa marcada."
      : `Total: ${ebd.length}\n\n` + ebd.map((n,i)=>`${i+1}. ${n}`).join("\n");

    const cultoTxt = (culto.length === 0)
      ? "Nenhuma presen√ßa marcada."
      : `Total: ${culto.length}\n\n` + culto.map((n,i)=>`${i+1}. ${n}`).join("\n");

    waText.value =
      `üìã G2 ‚Äî Presen√ßa (Domingo) ${dd}/${mm}/${y}\n\n` +
      `üìå EBD (manh√£)\n${ebdTxt}\n\n` +
      `üìå Culto (noite)\n${cultoTxt}`;
  }

  async function copyWhatsAppText(){
    try{
      await navigator.clipboard.writeText(waText.value);
      alert("Copiado! Agora √© s√≥ colar no WhatsApp.");
    }catch(e){
      waText.select();
      document.execCommand("copy");
      alert("Copiado! Agora √© s√≥ colar no WhatsApp.");
    }
  }

  // ====== PDF mensal ======
  function generateMonthlyPDF(){
    // Precisa estar carregado no navegador
    if(!window.jspdf || !window.jspdf.jsPDF){
      alert("Biblioteca de PDF n√£o carregou. Recarregue a p√°gina.");
      return;
    }
    const { jsPDF } = window.jspdf;

    const y = Number(yearSel.value);
    const mZero = Number(monthSel.value);
    const days = daysInMonth(y, mZero);

    const monthName = months[mZero];
    const key = monthKey();

    const doc = new jsPDF({ unit: "pt", format: "a4" });

    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text(`Relat√≥rio Mensal de Presen√ßa ‚Äî G2`, 40, 50);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text(`M√™s/Ano: ${monthName} / ${y}   (Ref: ${key})`, 40, 70);
    doc.text(`Gerado em: ${new Date().toLocaleString("pt-BR")}`, 40, 88);

    // Tabela (Data / Reuni√£o / Total / Nomes)
    const body = [];

    for(let d=1; d<=days; d++){
      const dd = String(d).padStart(2,"0");
      const mm = String(mZero+1).padStart(2,"0");
      const dateStr = `${dd}/${mm}/${y}`;
      const sunday = isSunday(y,mZero,d);

      if(!sunday){
        const nomes = getPresentNamesForDay(d, "C");
        body.push([dateStr, "Culto", String(nomes.length), nomes.join(", ") || "-"]);
      }else{
        const ebd = getPresentNamesForDay(d, "E");
        const culto = getPresentNamesForDay(d, "C");
        body.push([dateStr, "EBD (manh√£)", String(ebd.length), ebd.join(", ") || "-"]);
        body.push([dateStr, "Culto (noite)", String(culto.length), culto.join(", ") || "-"]);
      }
    }

    // @ts-ignore
    doc.autoTable({
      startY: 110,
      head: [["Data", "Reuni√£o", "Total", "Nomes"]],
      body,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 4, valign: "top" },
      headStyles: { fontStyle: "bold" },
      columnStyles: {
        0: { cellWidth: 70 },
        1: { cellWidth: 90 },
        2: { cellWidth: 40, halign: "center" },
        3: { cellWidth: 330 }
      },
      didDrawPage: (data) => {
        const pageCount = doc.internal.getNumberOfPages();
        doc.setFontSize(9);
        doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, 40, 820);
      }
    });

    doc.save(`G2_Presencas_${key}.pdf`);
  }

  // ====== Events ======
  document.getElementById("btnGenerate").addEventListener("click", generateWhatsAppText);
  document.getElementById("btnCopy").addEventListener("click", copyWhatsAppText);
  document.getElementById("btnPdf").addEventListener("click", generateMonthlyPDF);
  document.getElementById("btnClearDay").addEventListener("click", clearSelectedDay);
  document.getElementById("btnForceReload").addEventListener("click", ()=>location.reload());

  monthSel.addEventListener("change", ()=>{
    render(); generateWhatsAppText();
    if(db) attachMonthListener();
  });
  yearSel.addEventListener("change", ()=>{
    render(); generateWhatsAppText();
    if(db) attachMonthListener();
  });
  daySel.addEventListener("change", generateWhatsAppText);
  searchEl.addEventListener("input", render);

  // init UI
  refreshDaySelect();
  daySel.value = String(now.getDate());
  render();
  generateWhatsAppText();

  // start firebase
  initFirebase();
</script>

</body>
</html>
