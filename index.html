<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lista de Presen√ßa ‚Äì G2 S√£o Vicente</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 16px; }
    h1 { margin: 0 0 6px; }
    .sub { color:#555; margin: 0 0 14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label { display:flex; flex-direction:column; gap:4px; font-size:14px; }
    select, input[type="text"] { padding: 6px 8px; font-size: 14px; }
    button { padding: 7px 10px; font-size: 14px; cursor:pointer; border-radius:8px; border:1px solid #ddd; background:#fff; }
    .primary { background:#1a73e8; color:#fff; border:none; }
    .dangerBtn { background:#ff5b5b; color:#fff; border:none; }
    .wrap { overflow-x: auto; border:1px solid #eee; border-radius:10px; margin-top: 12px; }
    table { border-collapse: collapse; min-width: 900px; width: max-content; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: center; }
    th { position: sticky; top: 0; background: #f5f5f5; z-index: 2; }
    th.name, td.name { position: sticky; left: 0; background: #fff; z-index: 3; text-align: left; }
    .pill { display:inline-block; padding:2px 10px; border-radius:999px; background:#f1f1f1; font-size:12px; }
    .ok { background:#e8fff1; color:#0b7; border:1px solid #bff0d2; }
    .warn { background:#fff7e6; color:#b70; border:1px solid #ffe1a8; }
    .bad { background:#ffefef; color:#b00; border:1px solid #ffd2d2; }
    .panel { border:1px solid #eee; border-radius:10px; padding:12px; margin-top: 12px; }
    .panel h2 { margin:0 0 10px; font-size:16px; }
    .muted { color:#666; font-size:12px; margin: 8px 0 0; }
    .people { display:grid; grid-template-columns: 1fr auto; gap:8px; max-width: 560px; margin-top: 10px; }
    .nameCell { padding:6px 8px; border:1px solid #e5e5e5; border-radius:8px; background:#fff; }
  </style>
</head>
<body>
  <h1>Lista de Presen√ßa ‚Äì G2 S√£o Vicente</h1>
  <p class="sub">Marca√ß√µes e lista de nomes sincronizadas em tempo real via Firestore.</p>

  <div class="row">
    <label>M√™s
      <select id="month"></select>
    </label>
    <label>Ano
      <select id="year"></select>
    </label>
    <label>Dia (relat√≥rio)
      <select id="day"></select>
    </label>
    <button id="copy" class="primary">Copiar relat√≥rio (WhatsApp)</button>
    <button id="clearDay" class="dangerBtn">Limpar dia</button>
    <span id="status" class="pill warn">Conectando‚Ä¶</span>
  </div>

  <div class="panel">
    <h2>Adicionar / Remover nomes</h2>
    <div class="row">
      <label>Novo nome
        <input id="newName" type="text" placeholder="Digite o nome completo‚Ä¶" />
      </label>
      <button id="addName" class="primary">Adicionar</button>
    </div>
    <p class="muted">A lista j√° vem preenchida. Voc√™ pode adicionar e excluir nomes quando precisar.</p>
    <div id="peopleList" class="people"></div>
  </div>

  <div class="wrap">
    <table id="table"></table>
  </div>

<script type="module">
  // ========= CONFIGURE AQUI (COLE SEU firebaseConfig) =========
  const firebaseConfig = {
    apiKey: "COLE_AQUI",
    authDomain: "COLE_AQUI",
    projectId: "COLE_AQUI",
    storageBucket: "COLE_AQUI",
    messagingSenderId: "COLE_AQUI",
    appId: "COLE_AQUI"
  };
  // ===========================================================

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const statusEl = document.getElementById('status');
  const monthSel = document.getElementById('month');
  const yearSel  = document.getElementById('year');
  const daySel   = document.getElementById('day');
  const table    = document.getElementById('table');
  const peopleListEl = document.getElementById('peopleList');

  const CONFIG_DOC_ID = "__config__";

  // Lista FIXA (j√° preenchida) ‚Äî permanece como padr√£o inicial
  const defaultPeople = [
    "DEBORA MARGARETE C. SANTOS",
    "AGUINALDO BARBOSA",
    "ANNA AM√âLIA S. CAMARGO",
    "CAMILA CRISTINE DOS SANTOS",
    "CAMILA VENTURA SIM√ÉO MACEDO",
    "CARLA BEATRICE FERREIRA PINTO",
    "CASSIUS CLAY MACEDO",
    "GABRIEL SOUZA DOS SANTOS",
    "GABRIELA RICARTE SANTOS",
    "GLEISON CORREIA",
    "JORGE NICOL√ÅS PEREDO PINTO",
    "JOSEFA MARIA DE JESUS CAMPOS",
    "JOS√â CARLOS MENEZES SANTOS",
    "JO√ÉO HENRIQUE M. S. CORREIA",
    "KALEU DA SILVA OLIVEIRA",
    "KARINA S. O. PEDRINI",
    "LUDMILA MATHIAS",
    "NIVALDO DE JESUS SOARES",
    "PATR√çCIA SANTOS DE LIMA",
    "RACHEL RICARTE FREITAS",
    "ROMULO PEREDO MURTHA",
    "SAMUEL CARLOS G. M. MENEZES",
    "SOFIA JESUS DOS SANTOS",
    "VALENTINA PEREDO PINTO",
    "VERA LUCIA CONCEI√á√ÉO SANTOS",
    "WALTER CAMPOS FERREIRA",
    "WILLIAN JESUS SANTOS",
    "YASMIN FERREIRA VIEIRA SOARES",
    "ANDREIA SILVA GON√áALVES",
    "CILENE CRISTINA S. BARBOSA",
    "GILBERTO DOS SANTOS"
  ];

  // Estado
  let people = [];                 // [{id,name}]
  let currentMonthData = { marks: {} };
  let unsubMonth = null;
  let unsubConfig = null;

  function pad2(n){ return String(n).padStart(2,'0'); }
  function yyyymm(){ return `${yearSel.value}-${pad2(monthSel.value)}`; }
  function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }
  function slugId(name){
    // ID est√°vel baseado no nome (evita ‚Äúlista em branco‚Äù por IDs aleat√≥rios)
    return name
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,'-')
      .replace(/(^-|-$)/g,'')
      .slice(0, 60) || ("pessoa-" + Math.random().toString(36).slice(2,8));
  }

  function setStatus(text, cls){
    statusEl.textContent = text;
    statusEl.className = "pill " + (cls || "");
  }

  // Month/Year/Day UI
  const now = new Date();
  for (let m=0;m<12;m++){
    const o=document.createElement('option');
    o.value=m+1;
    o.textContent=new Date(0,m).toLocaleString('pt-BR',{month:'long'});
    if(m===now.getMonth()) o.selected=true;
    monthSel.appendChild(o);
  }

  // Mais anos (para durar)
  const startYear = now.getFullYear() - 5;
  const endYear   = now.getFullYear() + 30;
  for (let y=startYear; y<=endYear; y++){
    const o=document.createElement('option');
    o.value=y; o.textContent=y;
    if(y===now.getFullYear()) o.selected=true;
    yearSel.appendChild(o);
  }

  function refreshDayOptions(){
    const y=+yearSel.value, m=+monthSel.value;
    const dmax=daysInMonth(y,m);
    const prev = +daySel.value || now.getDate();
    daySel.innerHTML = "";
    for(let d=1; d<=dmax; d++){
      const o=document.createElement('option');
      o.value=d; o.textContent=d;
      if(d===Math.min(prev,dmax)) o.selected=true;
      daySel.appendChild(o);
    }
  }

  function sortedPeople(){
    return [...people].sort((a,b)=>a.name.localeCompare(b.name, "pt-BR"));
  }

  function renderPeopleManager(){
    peopleListEl.innerHTML = "";
    sortedPeople().forEach(p=>{
      const nameDiv = document.createElement('div');
      nameDiv.className = "nameCell";
      nameDiv.textContent = p.name;

      const delBtn = document.createElement('button');
      delBtn.className = "dangerBtn";
      delBtn.textContent = "Excluir";
      delBtn.onclick = async ()=>{
        if(!confirm(`Excluir o nome:\n\n${p.name}\n\nIsso remove o nome da lista para todos.`)) return;
        const cfgRef = doc(db,'presencas_g2', CONFIG_DOC_ID);
        await updateDoc(cfgRef, { [`people.${p.id}`]: deleteField() });
      };

      peopleListEl.appendChild(nameDiv);
      peopleListEl.appendChild(delBtn);
    });
  }

  function renderTable(){
    const y=+yearSel.value, m=+monthSel.value;
    const dmax=daysInMonth(y,m);

    let html = "<tr><th class='name'>Nome</th>";
    for(let d=1; d<=dmax; d++) html += `<th>${d}</th>`;
    html += "</tr>";

    sortedPeople().forEach(p=>{
      html += `<tr><td class='name'>${p.name}</td>`;
      for(let d=1; d<=dmax; d++){
        const key = `${p.id}-${d}`;
        const on = !!currentMonthData?.marks?.[key];
        html += `<td><input type='checkbox' ${on?"checked":""} data-pid='${p.id}' data-d='${d}'></td>`;
      }
      html += "</tr>";
    });

    table.innerHTML = html;

    table.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.onchange = async (e)=>{
        const pid = e.target.dataset.pid;
        const d = e.target.dataset.d;
        const ref = doc(db,'presencas_g2', yyyymm());
        if(e.target.checked){
          await updateDoc(ref, { [`marks.${pid}-${d}`]: true });
        }else{
          await updateDoc(ref, { [`marks.${pid}-${d}`]: deleteField() });
        }
      };
    });
  }

  function attachMonthDoc(){
    if(unsubMonth) unsubMonth();
    const ref = doc(db,'presencas_g2', yyyymm());
    setDoc(ref, { marks:{} }, { merge:true });
    unsubMonth = onSnapshot(ref, snap=>{
      currentMonthData = snap.data() || { marks:{} };
      renderTable();
    });
  }

  function attachConfigDoc(){
    if(unsubConfig) unsubConfig();
    const cfgRef = doc(db,'presencas_g2', CONFIG_DOC_ID);
    unsubConfig = onSnapshot(cfgRef, snap=>{
      const data = snap.data() || {};
      const map = data.people || {};
      people = Object.entries(map).map(([id,name])=>({id, name}));
      renderPeopleManager();
      renderTable();
    });
  }

  async function ensureConfigSeededOnce(){
    const cfgRef = doc(db,'presencas_g2', CONFIG_DOC_ID);
    const snap = await getDoc(cfgRef);
    if(snap.exists()){
      return; // j√° existe: N√ÉO sobrescreve (evita ‚Äúlista em branco‚Äù/troca de IDs)
    }
    const seeded = {};
    defaultPeople.forEach(name=>{
      seeded[slugId(name)] = name;
    });
    await setDoc(cfgRef, { people: seeded }, { merge:false });
  }

  document.getElementById('addName').onclick = async ()=>{
    const input = document.getElementById('newName');
    const name = (input.value || "").trim();
    if(!name) { alert("Digite um nome."); return; }
    const id = slugId(name);
    const cfgRef = doc(db,'presencas_g2', CONFIG_DOC_ID);
    await updateDoc(cfgRef, { [`people.${id}`]: name });
    input.value = "";
  };

  document.getElementById('copy').onclick = ()=>{
    const y=yearSel.value, m=pad2(monthSel.value), d=daySel.value;
    const presentes = sortedPeople()
      .filter(p=>currentMonthData?.marks?.[`${p.id}-${d}`])
      .map(p=>p.name);

    const txt = `üìã G2 ‚Äî Presen√ßa (${d}/${m}/${y})\nTotal: ${presentes.length}\n\n` +
      presentes.map((n,i)=>`${i+1}. ${n}`).join("\n");

    navigator.clipboard.writeText(txt)
      .then(()=>alert("Relat√≥rio copiado! Cole no WhatsApp."))
      .catch(()=>alert("N√£o consegui copiar automaticamente. Tente novamente."));
  };

  document.getElementById('clearDay').onclick = async ()=>{
    const y=yearSel.value, m=pad2(monthSel.value), d=daySel.value;
    if(!confirm(`Limpar TODAS as presen√ßas do dia ${d}/${m}/${y} para TODOS?`)) return;

    const ref = doc(db,'presencas_g2', yyyymm());
    const updates = {};
    for(const p of people){
      updates[`marks.${p.id}-${d}`] = deleteField();
    }
    await updateDoc(ref, updates);
    alert("Dia limpo!");
  };

  monthSel.onchange = ()=>{ refreshDayOptions(); attachMonthDoc(); };
  yearSel.onchange  = ()=>{ refreshDayOptions(); attachMonthDoc(); };

  onAuthStateChanged(auth, (user)=>{
    if(user) setStatus("Conectado", "ok");
    else setStatus("Conectando‚Ä¶", "warn");
  });

  try {
    await signInAnonymously(auth);
    await ensureConfigSeededOnce();  // garante que a lista j√° vem preenchida
    refreshDayOptions();
    attachConfigDoc();
    attachMonthDoc();
    setStatus("Conectado", "ok");
  } catch (e){
    console.error(e);
    setStatus("Erro de conex√£o", "bad");
    alert("Erro ao conectar no Firebase. Confira o firebaseConfig, Auth An√¥nima e as Regras do Firestore.");
  }
</script>
</body>
</html>
