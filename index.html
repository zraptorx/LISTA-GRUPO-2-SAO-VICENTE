<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lista de Presen√ßa ‚Äì G2</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#fff;color:#111}
    h1{font-size:20px;margin:0 0 6px 0}
    .muted{color:#666;font-size:12px;margin-bottom:10px}
    button,select,input,textarea{padding:10px;font-size:15px;border-radius:8px;border:1px solid #ccc;margin:4px 0;background:#fff}
    button{cursor:pointer}
    button.primary{border-color:#111;background:#f0f0f0}
    button.danger{border-color:#a33;color:#a33}
    button.success{border-color:#16a34a;color:#16a34a}
    .topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;padding:12px;border:1px solid #ddd;border-radius:12px;background:#fafafa;margin:12px 0}
    .field{display:flex;flex-direction:column;gap:6px}
    .box{border:1px solid #ddd;border-radius:12px;padding:12px;background:#fff;margin-top:12px}
    textarea{width:100%;min-height:130px;resize:vertical}
    .small{font-size:12px;color:#666}
    .tableWrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid #ddd;border-radius:12px;background:#fff}
    table{border-collapse:collapse;width:max-content;min-width:100%;margin-top:0}
    th,td{border:1px solid #ddd;padding:6px;text-align:center;white-space:nowrap}
    th{background:#f2f2f2;font-size:12px;position:sticky;top:0;z-index:3}
    
    /* CORRE√á√ÉO DA C√âLULA DE NOMES */
    th.nameHead, td.name{
      position:sticky;
      left:0;
      z-index:4;
      background:#fff !important;
      text-align:left;
      min-width:260px;
      max-width:260px;
      border-right:2px solid #ddd;
      /* Impede que o nome vaze da c√©lula */
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th.nameHead{z-index:5; background:#f2f2f2 !important}
    
    td.name{font-weight:600; display: flex; justify-content: space-between; align-items: center;}
    td.day{min-width:38px; cursor:pointer;}
    .present{background:#d1f3dc}
    .statusLine{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 12px;border:1px solid #ddd;border-radius:12px;background:#fff}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .dot.ok{background:#16a34a}
    .dot.wait{background:#f59e0b}
    .dot.bad{background:#dc2626}
    .btn-del{color: #a33; border: none; background: none; font-weight: bold; cursor: pointer; padding: 0 5px;}
  </style>
</head>
<body>

<h1>üìã Lista de Presen√ßa ‚Äì G2</h1>
<div class="muted">Os meses anteriores ficam salvos no banco de dados automaticamente. </div>

<div class="statusLine">
  <span><span class="dot wait" id="dot"></span><b id="statusText">Conectando‚Ä¶</b></span>
  <span class="small" id="statusDetail">Verificando banco de dados.</span>
</div>

<div class="box">
  <div style="display:flex; gap:10px">
    <input type="text" id="newName" placeholder="NOME DO NOVO MEMBRO" style="flex:1">
    <button id="btnAdd" class="primary">Adicionar</button>
  </div>
</div>

<div class="topbar">
  <div class="field"><div class="small">M√™s</div><select id="month"></select></div>
  <div class="field"><div class="small">Ano</div><select id="year"></select></div>
  <div class="field"><div class="small">Dia (WhatsApp)</div><select id="daySelect"></select></div>
  <div class="field" style="flex:1;min-width:200px"><div class="small">Buscar</div><input id="search" type="text" placeholder="Filtrar por nome..."></div>
  <div class="field"><button id="btnPdf" class="primary">PDF Mensal</button></div>
  <div class="field"><button id="btnBackup" class="success">‚¨áÔ∏è Backup</button></div>
  <div class="field"><button id="btnRestore" class="success">‚¨ÜÔ∏è Restaurar</button></div>
  <input type="file" id="fileRestore" style="display:none" accept=".json">
</div>

<div class="tableWrap"><table id="table"></table></div>

<div class="box">
  <button id="btnGenerate" class="primary">Gerar Texto</button>
  <button id="btnCopy" class="primary">Copiar</button>
  <button id="btnSendWa" class="success">üì± Enviar WhatsApp</button>
  <button id="btnClearDay" class="danger">Limpar Dia</button>
  <textarea id="waText" readonly placeholder="Texto aparecer√° aqui..."></textarea>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyCM0nYBjOaHWKVjUm6PPpPjQ2MdAiqil0s",
    authDomain: "lista-grupo-2-sao-vicente.firebaseapp.com",
    projectId: "lista-grupo-2-sao-vicente",
    storageBucket: "lista-grupo-2-sao-vicente.appspot.com",
    messagingSenderId: "95897300612",
    appId: "1:95897300612:web:e18378220805a70061dcd1"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const monthSel = document.getElementById("month"), yearSel = document.getElementById("year"), daySel = document.getElementById("daySelect"), table = document.getElementById("table"), searchEl = document.getElementById("search"), waText = document.getElementById("waText"), dot = document.getElementById("dot"), statusText = document.getElementById("statusText");

  const months = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  months.forEach((m,i)=> monthSel.add(new Option(m,i)));
  monthSel.value = new Date().getMonth();
  for(let y=2024; y<=2026; y++) yearSel.add(new Option(y,y));
  yearSel.value = new Date().getFullYear();

  let people = [], marks = {}, db, currentDocRef, peopleDocRef;

  function updateDayOptions() {
    const days = new Date(yearSel.value, Number(monthSel.value)+1, 0).getDate();
    const current = daySel.value;
    daySel.innerHTML = "";
    for(let d=1; d<=days; d++) daySel.add(new Option(d,d));
    daySel.value = current <= days ? current : 1;
  }

  async function attachListeners(){
    updateDayOptions();
    const mKey = `${yearSel.value}-${String(Number(monthSel.value)+1).padStart(2,"0")}`;
    currentDocRef = doc(db, "presencas_g2", mKey);
    peopleDocRef = doc(db, "presencas_g2_meta", "people");

    onSnapshot(peopleDocRef, snap => { if(snap.exists()) people = snap.data().people || []; render(); });
    onSnapshot(currentDocRef, snap => { marks = snap.exists() ? snap.data().marks || {} : {}; render(); });
  }

  function render(){
    const days = new Date(yearSel.value, Number(monthSel.value)+1, 0).getDate();
    const q = searchEl.value.toLowerCase();
    let h = "<tr><th class='nameHead'>Nome</th>";
    for(let d=1; d<=days; d++) h += `<th>${d}</th>`;
    h += "</tr>";

    people.filter(p => p.name.toLowerCase().includes(q)).forEach(p => {
      h += `<tr><td class="name"><span>${p.name}</span> <button class="btn-del" onclick="delMember('${p.id}')">‚úï</button></td>`;
      for(let d=1; d<=days; d++) {
        const k = `${p.id}-${d}-C`;
        h += `<td class="day ${marks[k]?'present':''}" onclick="toggle('${p.id}',${d})">${marks[k]?'X':''}</td>`;
      }
      h += "</tr>";
    });
    table.innerHTML = h;
  }

  window.toggle = async (pid, d) => {
    const k = `marks.${pid}-${d}-C`;
    await updateDoc(currentDocRef, { [k]: marks[`${pid}-${d}-C`] ? deleteField() : true });
  };

  window.delMember = async (id) => {
    if(confirm("Remover membro?")) {
      const newList = people.filter(p => p.id !== id);
      await setDoc(peopleDocRef, { people: newList });
    }
  };

  // BOT√ÉO WHATSAPP
  document.getElementById("btnSendWa").onclick = () => {
    if(!waText.value) return alert("Gere o texto primeiro!");
    window.open(`https://wa.me/?text=${encodeURIComponent(waText.value)}`, '_blank');
  };

  // BOT√ÉO GERAR TEXTO
  document.getElementById("btnGenerate").onclick = () => {
    const d = daySel.value;
    const pres = people.filter(p => marks[`${p.id}-${d}-C`]).map(p => p.name).sort();
    waText.value = `üìã G2 - Presen√ßa (${d}/${Number(monthSel.value)+1}/${yearSel.value})\nTotal: ${pres.length}\n\n` + pres.map((n,i)=>`${i+1}. ${n}`).join("\n");
  };

  // BOT√ÉO COPIAR
  document.getElementById("btnCopy").onclick = () => { waText.select(); document.execCommand("copy"); alert("Copiado!"); };

  // BOT√ÉO BACKUP
  document.getElementById("btnBackup").onclick = () => {
    const blob = new Blob([JSON.stringify({people, marks}, null, 2)], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `backup_G2_${monthSel.value+1}_${yearSel.value}.json`;
    a.click();
  };

  // BOT√ÉO RESTAURAR
  document.getElementById("btnRestore").onclick = () => document.getElementById("fileRestore").click();
  document.getElementById("fileRestore").onchange = (e) => {
    const reader = new FileReader();
    reader.onload = async (ev) => {
      const data = JSON.parse(ev.target.result);
      if(confirm("Restaurar dados?")) {
        await setDoc(peopleDocRef, { people: data.people }, { merge: true });
        await setDoc(currentDocRef, { marks: data.marks }, { merge: true });
        alert("Restaurado!");
      }
    };
    reader.readAsText(e.target.files[0]);
  };

  // BOT√ÉO PDF MENSAL (CONFORME MODELO ICM)
  document.getElementById("btnPdf").onclick = () => {
    const { jsPDF } = window.jspdf;
    const docPdf = new jsPDF('l', 'mm', 'a4');
    const days = new Date(yearSel.value, Number(monthSel.value)+1, 0).getDate();
    
    docPdf.setFontSize(14);
    docPdf.text("IGREJA CRISTA MARANATA", 14, 15);
    docPdf.setFontSize(10);
    docPdf.text(`Chamada do Grupo de Assist√™ncia: G2 - Romulo Peredo`, 14, 22);
    docPdf.text(`Refer√™ncia: ${months[monthSel.value]} / ${yearSel.value}`, 230, 22);

    const rows = people.map((p, i) => {
      const row = [i + 1, p.name];
      for(let d=1; d<=days; d++) row.push(marks[`${p.id}-${d}-C`] ? "X" : "");
      return row;
    });

    docPdf.autoTable({
      head: [['#', 'Pessoa', ...Array.from({length: days}, (_, i) => i + 1)]],
      body: rows,
      startY: 30,
      styles: { fontSize: 7, cellPadding: 1 },
      headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0] }
    });
    docPdf.save(`Chamada_G2_${months[monthSel.value]}.pdf`);
  };

  // INICIALIZA√á√ÉO FIREBASE
  (async ()=>{
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    const auth = getAuth(app);
    await signInAnonymously(auth);
    onAuthStateChanged(auth, user => { if(user) { dot.className="dot ok"; statusText.textContent="Conectado"; attachListeners(); } });
  })();

  monthSel.onchange = yearSel.onchange = attachListeners;
  searchEl.oninput = render;
  document.getElementById("btnAdd").onclick = async () => {
    const n = document.getElementById("newName").value.trim().toUpperCase();
    if(n) await setDoc(peopleDocRef, { people: [...people, {id: "p"+Date.now(), name: n}].sort((a,b)=>a.name.localeCompare(b.name)) });
    document.getElementById("newName").value = "";
  };
</script>
</body>
</html>