<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Lista de Presença – Grupo 2 São Vicente</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:12px; }
  h1 { text-align:center; margin:6px 0 4px; }
  .sub { text-align:center; color:#555; margin:0 0 10px; }

  .wrap { overflow-x:auto; background:#fff; border-radius:12px; border:1px solid #ddd; }
  table { border-collapse:collapse; width:max-content; min-width:980px; background:#fff; }
  th, td { border:1px solid #ddd; padding:6px 8px; text-align:center; }
  th { position:sticky; top:0; background:#f5f5f5; z-index:3; }

  th.name, td.name {
    position:sticky; left:0; background:#fff; z-index:5;
    text-align:left; font-weight:bold; min-width:260px;
    white-space:normal; word-break:break-word;
  }
  th.name { z-index:6; }

  th.day { min-width:38px; font-size:13px; }
  td input { width:18px; height:18px; }

  .controls { display:flex; gap:8px; justify-content:center; margin:10px 0; flex-wrap:wrap; }
  .controls input, .controls button { padding:8px 10px; font-size:14px; }
  .danger { background:#c62828; color:#fff; border:none; cursor:pointer; }

  .footer { text-align:center; font-size:12px; color:#666; margin-top:10px; }
</style>
</head>

<body>

<h1>Lista de Presença – Grupo 2</h1>
<p class="sub" id="monthLabel"></p>

<div class="controls">
  <input id="newName" placeholder="Adicionar novo nome">
  <button onclick="addPerson()">Adicionar</button>
</div>

<div class="wrap">
  <table id="table"></table>
</div>

<div class="footer">Firebase • Sincronização em tempo real</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, updateDoc,
    onSnapshot, serverTimestamp, getDoc, deleteField
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCM0nYBjOaHWKVjUm6PPpPjQ2MdAiqil0s",
    authDomain: "lista-grupo-2-sao-vicente.firebaseapp.com",
    projectId: "lista-grupo-2-sao-vicente",
    storageBucket: "lista-grupo-2-sao-vicente.firebasestorage.app",
    messagingSenderId: "95897300612",
    appId: "1:95897300612:web:f0ffeb7327be921361dcd1"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  await signInAnonymously(auth);

  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth()+1).padStart(2,"0");
  const monthId = `${year}-${month}`;
  document.getElementById("monthLabel").innerText =
    now.toLocaleDateString("pt-BR",{month:"long",year:"numeric"});

  const docRef = doc(db,"presencas_g2",monthId);

  const defaultNames = [
    "DEBORA MARGARETE C. SANTOS","AGUINALDO BARBOSA","ANNA AMÉLIA S. CAMARGO",
    "CAMILA CRISTINE DOS SANTOS","CAMILA VENTURA SIMÃO MACEDO","CARLA BEATRICE FERREIRA PINTO",
    "CASSIUS CLAY MACEDO","GABRIEL SOUZA DOS SANTOS","GABRIELA RICARTE SANTOS","GLEISON CORREIA",
    "JORGE NICOLÁS PEREDO PINTO","JOSEFA MARIA DE JESUS CAMPOS","JOSÉ CARLOS MENEZES SANTOS",
    "JOÃO HENRIQUE M. S. CORREIA","KALEU DA SILVA OLIVEIRA"
  ];

  await setDoc(docRef,{ names: defaultNames, marks:{}, updatedAt:serverTimestamp() },{merge:true});

  const table = document.getElementById("table");
  const daysInMonth = new Date(year, month, 0).getDate();

  function render(data){
    const names = data.names || [];
    const marks = data.marks || {};
    table.innerHTML = "";

    let h = "<tr><th class='name'>Nome</th>";
    for(let d=1; d<=daysInMonth; d++) h+=`<th class="day">${d}</th>`;
    h+="<th>Remover</th></tr>";
    table.innerHTML += h;

    names.forEach(name=>{
      let r = `<tr><td class="name">${name}</td>`;
      for(let d=1; d<=daysInMonth; d++){
        const c = marks?.[d]?.[name] ? "checked":"";
        r+=`<td><input type="checkbox" ${c}
          onchange="setMark(${d},${JSON.stringify(name)},this.checked)"></td>`;
      }
      r+=`<td><button class="danger" onclick="removePerson(${JSON.stringify(name)})">X</button></td></tr>`;
      table.innerHTML+=r;
    });
  }

  onSnapshot(docRef,snap=>{ if(snap.exists()) render(snap.data()); });

  window.setMark = async(day,name,val)=>{
    await updateDoc(docRef,{[`marks.${day}.${name}`]:val,updatedAt:serverTimestamp()});
  };

  window.addPerson = async()=>{
    const i=document.getElementById("newName");
    const n=i.value.trim().toUpperCase();
    if(!n) return;
    const s=await getDoc(docRef);
    await updateDoc(docRef,{names:[...new Set([...s.data().names,n])]});
    i.value="";
  };

  window.removePerson = async(name)=>{
    const s=await getDoc(docRef);
    await updateDoc(docRef,{names:s.data().names.filter(x=>x!==name)});
    for(let d=1; d<=daysInMonth; d++)
      await updateDoc(docRef,{[`marks.${d}.${name}`]:deleteField()});
  };
</script>

</body>
</html>
