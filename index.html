<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lista G2 - Hist√≥rico e Sincroniza√ß√£o</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#fff;color:#111}
    h1{font-size:20px;margin:0 0 6px 0}
    .muted{color:#666;font-size:12px;margin-bottom:10px}
    button,select,input,textarea{padding:10px;font-size:15px;border-radius:8px;border:1px solid #ccc;margin:4px 0;background:#fff}
    button{cursor:pointer}
    button.primary{border-color:#111;background:#f0f0f0}
    button.success{border-color:#16a34a;color:#16a34a}
    button.danger{border-color:#a33;color:#a33}
    
    .statusLine{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 12px;border:1px solid #ddd;border-radius:12px;background:#fff;margin-bottom:10px}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .dot.ok{background:#16a34a}
    .dot.wait{background:#f59e0b}
    
    .topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;padding:12px;border:1px solid #ddd;border-radius:12px;background:#fafafa;margin:12px 0}
    .field{display:flex;flex-direction:column;gap:6px}
    .box{border:1px solid #ddd;border-radius:12px;padding:12px;background:#fff;margin-top:12px}
    
    /* FIXA√á√ÉO DA COLUNA DE NOMES */
    .tableWrap{width:100%;overflow-x:auto;border:1px solid #ddd;border-radius:12px;max-height: 500px;}
    table{border-collapse:collapse;width:max-content;min-width:100%}
    th,td{border:1px solid #ddd;padding:8px;text-align:center;white-space:nowrap;background:#fff}
    
    /* Esta √© a parte que trava os nomes no lugar */
    th.nameHead, td.name {
      position: sticky;
      left: 0;
      z-index: 10; 
      background-color: #fff !important;
      border-right: 2px solid #ddd;
      text-align: left;
      min-width: 220px;
    }
    th.nameHead { z-index: 11; background-color: #f2f2f2 !important; }
    
    .present{background:#d1f3dc !important}
    td.day{cursor:pointer; min-width:35px}
    textarea{width:100%;min-height:100px;margin-top:10px}
    .del-btn{color:red; border:none; background:none; cursor:pointer; float:right}
  </style>
</head>
<body>

<h1>üìã Lista G2 - Hist√≥rico e Sincroniza√ß√£o</h1>
<div class="muted">Os meses anteriores ficam salvos no banco de dados automaticamente. </div>

<div class="statusLine">
  <span class="dot wait" id="dot"></span><b id="statusText">Conectando...</b>
</div>

<div class="box">
  <div style="display:flex; gap:10px">
    <input type="text" id="newName" placeholder="NOME DO NOVO MEMBRO" style="flex:1">
    <button id="btnAdd" class="primary">Adicionar</button>
  </div>
</div>

<div class="topbar">
  <div class="field"><div class="small">M√™s</div><select id="monthSelect"></select></div>
  <div class="field"><div class="small">Ano</div><select id="yearSelect"></select></div>
  <div class="field"><div class="small">Dia</div><select id="daySelect"></select></div>
  <div class="field" style="flex:1"><div class="small">Buscar</div><input id="search" type="text" placeholder="Filtrar..."></div>
  <button id="btnBackup" class="success">‚¨áÔ∏è Backup</button>
  <button id="btnRestore" class="success">‚¨ÜÔ∏è Restaurar</button>
</div>

<div class="tableWrap">
  <table id="mainTable"></table>
</div>

<div class="box">
  <button id="btnGenerate" class="primary">Gerar Texto</button>
  <button id="btnSendWa" class="success">üì± Enviar p/ WhatsApp</button>
  <button id="btnClearDay" class="danger">Limpar Dia</button>
  <textarea id="waText" readonly></textarea>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, setDoc, updateDoc, deleteField, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCM0nYBjOaHWKVjUm6PPpPjQ2MdAiqil0s",
    authDomain: "lista-grupo-2-sao-vicente.firebaseapp.com",
    projectId: "lista-grupo-2-sao-vicente",
    storageBucket: "lista-grupo-2-sao-vicente.appspot.com",
    messagingSenderId: "95897300612",
    appId: "1:95897300612:web:e18378220805a70061dcd1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let people = [], marks = {};
  const mSel = document.getElementById('monthSelect'), ySel = document.getElementById('yearSelect'), dSel = document.getElementById('daySelect');

  // Inicializa√ß√£o de datas
  const months = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  months.forEach((m, i) => mSel.add(new Option(m, i)));
  mSel.value = new Date().getMonth();
  for(let y=2024; y<=2026; y++) ySel.add(new Option(y, y));
  ySel.value = new Date().getFullYear();

  function updateDays() {
    const total = new Date(ySel.value, parseInt(mSel.value)+1, 0).getDate();
    dSel.innerHTML = "";
    for(let i=1; i<=total; i++) dSel.add(new Option(i, i));
  }

  async function sync() {
    const key = `${ySel.value}-${String(parseInt(mSel.value)+1).padStart(2,'0')}`;
    updateDays();
    
    onSnapshot(doc(db, "presencas_g2_meta", "people"), snap => {
      people = snap.exists() ? snap.data().people : [];
      render();
    });

    onSnapshot(doc(db, "presencas_g2", key), snap => {
      marks = snap.exists() ? snap.data().marks : {};
      render();
    });
  }

  function render() {
    const days = new Date(ySel.value, parseInt(mSel.value)+1, 0).getDate();
    const filter = document.getElementById('search').value.toLowerCase();
    let h = `<tr><th class="nameHead">Nome</th>`;
    for(let d=1; d<=days; d++) h += `<th>${d}</th>`;
    h += `</tr>`;

    people.filter(p => p.name.toLowerCase().includes(filter)).forEach(p => {
      h += `<tr><td class="name">${p.name} <button class="del-btn" onclick="window.del('${p.id}')">‚úï</button></td>`;
      for(let d=1; d<=days; d++) {
        const k = `${p.id}-${d}-C`;
        h += `<td class="day ${marks[k]?'present':''}" onclick="window.tk('${p.id}',${d})">${marks[k]?'X':''}</td>`;
      }
      h += `</tr>`;
    });
    document.getElementById('mainTable').innerHTML = h;
  }

  window.tk = async (pid, d) => {
    const key = `${ySel.value}-${String(parseInt(mSel.value)+1).padStart(2,'0')}`;
    const k = `${pid}-${d}-C`;
    await setDoc(doc(db, "presencas_g2", key), { marks: { [k]: marks[k] ? deleteField() : true } }, { merge: true });
  };

  window.del = async (id) => {
    if(confirm("Remover membro?")) {
      const newList = people.filter(p => p.id !== id);
      await setDoc(doc(db, "presencas_g2_meta", "people"), { people: newList });
    }
  };

  document.getElementById('btnAdd').onclick = async () => {
    const name = document.getElementById('newName').value.toUpperCase().trim();
    if(!name) return;
    const newList = [...people, { id: 'p'+Date.now(), name }].sort((a,b)=>a.name.localeCompare(b.name));
    await setDoc(doc(db, "presencas_g2_meta", "people"), { people: newList });
    document.getElementById('newName').value = "";
  };

  document.getElementById('btnSendWa').onclick = () => {
    const txt = document.getElementById('waText').value;
    if(txt) window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
  };

  signInAnonymously(auth).then(() => {
    document.getElementById('dot').className = "dot ok";
    document.getElementById('statusText').innerText = "Conectado";
    sync();
  });

  mSel.onchange = ySel.onchange = sync;
  document.getElementById('search').oninput = render;
</script>
</body>
</html>