<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lista de PresenÃ§a â€“ G2</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#fff;color:#111}
    h1{font-size:20px;margin:0 0 6px 0}
    .muted{color:#666;font-size:12px;margin-bottom:10px}
    button,select,input,textarea{padding:10px;font-size:15px;border-radius:8px;border:1px solid #ccc;margin:4px 0;background:#fff}
    button{cursor:pointer}
    button.primary{border-color:#111}
    button.danger{border-color:#a33;color:#a33}
    .topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;padding:12px;border:1px solid #ddd;border-radius:12px;background:#fafafa;margin:12px 0}
    .field{display:flex;flex-direction:column;gap:6px}
    .box{border:1px solid #ddd;border-radius:12px;padding:12px;background:#fff;margin-top:12px}
    textarea{width:100%;min-height:130px;resize:vertical}
    .small{font-size:12px;color:#666}
    .tableWrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid #ddd;border-radius:12px;background:#fff}
    table{border-collapse:collapse;width:max-content;min-width:100%;margin-top:0}
    th,td{border:1px solid #ddd;padding:6px;text-align:center;white-space:nowrap}
    th{background:#f2f2f2;font-size:12px;position:sticky;top:0;z-index:3}
    th.nameHead, td.name{position:sticky;left:0;z-index:4;background:#fff;text-align:left;min-width:260px;max-width:260px;border-right:2px solid #ddd}
    td.name{font-weight:600}
    td.day{min-width:38px; cursor:pointer;}
    .present{background:#d1f3dc}
    .statusLine{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 12px;border:1px solid #ddd;border-radius:12px;background:#fff}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .dot.ok{background:#16a34a}
    .dot.wait{background:#f59e0b}
    .dot.bad{background:#dc2626}
    th .sub{display:block;font-size:10px;color:#444;margin-top:2px}
    .manageGrid{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;margin-top:10px}
    .manageGrid .field{min-width:220px;flex:1}
    @media (max-width:640px){th.nameHead, td.name{min-width:220px;max-width:220px}}
  </style>
</head>
<body>

<h1>ðŸ“‹ Lista de PresenÃ§a â€“ G2</h1>
<div class="muted">RelatÃ³rio PDF com marcaÃ§Ã£o "X" conforme padrÃ£o oficial.</div>

<div class="statusLine">
  <span><span class="dot wait" id="dot"></span><b id="statusText">Conectandoâ€¦</b></span>
  <span class="small" id="statusDetail">Verificando banco de dados.</span>
</div>

<div class="topbar">
  <div class="field"><div class="small">MÃªs</div><select id="month"></select></div>
  <div class="field"><div class="small">Ano</div><select id="year"></select></div>
  <div class="field"><div class="small">Dia (WhatsApp)</div><select id="daySelect"></select></div>
  <div class="field" style="flex:1;min-width:200px"><div class="small">Buscar</div><input id="search" type="text" placeholder="Filtrar por nome..."></div>
  <div class="field"><button id="btnGenerate" class="primary">Gerar Texto</button></div>
  <div class="field"><button id="btnCopy" class="primary">Copiar</button></div>
  <div class="field"><button id="btnPdf" class="primary">Gerar PDF Mensal</button></div>
  <div class="field"><button id="btnClearDay" class="danger">Limpar Dia</button></div>
</div>

<div class="box">
  <div class="manageGrid">
    <div class="field"><div class="small">Novo Nome</div><input id="newPersonName" type="text" placeholder="NOME COMPLETO"></div>
    <div class="field"><button id="btnAddPerson" class="primary">Adicionar</button></div>
    <div class="field"><div class="small">Remover Pessoa</div><select id="removePersonSelect"></select></div>
    <div class="field"><button id="btnRemovePerson" class="danger">Remover</button></div>
  </div>
</div>

<div class="tableWrap"><table id="table"></table></div>

<div class="box">
  <textarea id="waText" readonly placeholder="Texto do WhatsApp aparecerÃ¡ aqui..."></textarea>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyCM0nYBjOaHWKVjUm6PPpPjQ2MdAiqil0s",
    authDomain: "lista-grupo-2-sao-vicente.firebaseapp.com",
    projectId: "lista-grupo-2-sao-vicente",
    storageBucket: "lista-grupo-2-sao-vicente.appspot.com",
    messagingSenderId: "95897300612",
    appId: "1:95897300612:web:e18378220805a70061dcd1"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteField, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const monthSel = document.getElementById("month"), yearSel = document.getElementById("year"), daySel = document.getElementById("daySelect"), table = document.getElementById("table"), searchEl = document.getElementById("search"), waText = document.getElementById("waText"), dot = document.getElementById("dot"), statusText = document.getElementById("statusText"), statusDetail = document.getElementById("statusDetail"), newPersonNameEl = document.getElementById("newPersonName"), removePersonSelect = document.getElementById("removePersonSelect");

  const months = ["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  months.forEach((m,i)=>{ const o=document.createElement("option"); o.value=i; o.text=m; monthSel.appendChild(o); });
  const now = new Date(); monthSel.value = now.getMonth();
  for(let y=now.getFullYear()-1; y<=now.getFullYear()+2; y++){ const o=document.createElement("option"); o.value=y; o.text=y; yearSel.appendChild(o); }
  yearSel.value = now.getFullYear();

  let people = [], marks = {}, app, auth, db, unsubscribeMonth, unsubscribePeople, currentDocRef, peopleDocRef;

  const membrosInfo = {
    "DEBORA MARGARETE C. SANTOS": { sit: "Cnd.Bat", tel: "13981452140" },
    "AGUINALDO BARBOSA": { sit: "Membro", tel: "13996199250" },
    "ANNA AMÃ‰LIA S. CAMARGO": { sit: "Membro", tel: "1334681763" },
    "CAMILA CRISTINE DOS SANTOS": { sit: "Membro", tel: "1334621945" },
    "CARLA BEATRICE FERREIRA PINTO": { sit: "Membro", tel: "5513991588330" },
    "GABRIEL SOUZA DOS SANTOS": { sit: "Membro", tel: "013997711332" },
    "GABRIELA RICARTE SANTOS": { sit: "Membro", tel: "13981212142" },
    "GLEISON CORREIA": { sit: "Membro", tel: "1333729245" },
    "JORGE NICOLÃS PEREDO PINTO": { sit: "Membro", tel: "13991590807" },
    "JOSEFA MARIA DE JESUS CAMPOS": { sit: "Membro", tel: "5513991828253" },
    "JOSÃ‰ CARLOS MENEZES SANTOS": { sit: "Membro", tel: "1330276314" },
    "JOÃƒO HENRIQUE M. S. CORREIA": { sit: "Membro", tel: "33729245" },
    "KALEU DA SILVA OLIVEIRA": { sit: "Membro", tel: "13988808106" },
    "KARINA S. O. PEDRINI": { sit: "Membro", tel: "2222107690" },
    "LUDMILA MATHIAS": { sit: "Membro", tel: "1333729245" },
    "NIVALDO DE JESUS SOARES": { sit: "Membro", tel: "13974099355" },
    "PATRÃCIA SANTOS DE LIMA": { sit: "Membro", tel: "13996714581" },
    "RACHEL RICARTE FREITAS": { sit: "Membro", tel: "013981212142" },
    "ROMULO PEREDO MURTHA": { sit: "Membro", tel: "13991590807" },
    "SAMUEL CARLOS G. M. MENEZES": { sit: "Membro", tel: "13991210262" },
    "SOFIA JESUS DOS SANTOS": { sit: "Membro", tel: "13988133046" },
    "VALENTINA PEREDO PINTO": { sit: "Membro", tel: "13991588330" },
    "VERA LUCIA CONCEIÃ‡ÃƒO SANTOS": { sit: "Membro", tel: "1388326860" },
    "WALTER CAMPOS FERREIRA": { sit: "Membro", tel: "5513981782007" },
    "WILLIAN JESUS SANTOS": { sit: "Membro", tel: "13981714070" },
    "YASMIN FERREIRA VIEIRA SOARES": { sit: "Membro", tel: "13992049851" },
    "ANDREIA SILVA GONÃ‡ALVES": { sit: "Visitante", tel: "13988330979" },
    "CILENE CRISTINA S. BARBOSA": { sit: "Visitante", tel: "13996282667" },
    "GILBERTO DOS SANTOS": { sit: "Visitante", tel: "1388326860" }
  };

  function setStatus(kind, text, detail){ dot.className = "dot " + (kind==="ok"?"ok":kind==="bad"?"bad":"wait"); statusText.textContent = text; statusDetail.textContent = detail || ""; }
  function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
  function isSunday(y, m0, d){ return new Date(y, m0, d).getDay() === 0; }
  function monthKey(){ return yearSel.value + "-" + String(Number(monthSel.value)+1).padStart(2,"0"); }
  function normalize(s){ return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(); }
  function markKey(pid, d, t){ return `${pid}-${d}-${t}`; }

  async function ensureDocExists(ref){
    const snap = await getDoc(ref);
    if(!snap.exists()) await setDoc(ref, { marks: {} }, { merge: true });
  }

  function render(){
    const y = Number(yearSel.value), m = Number(monthSel.value), days = daysInMonth(y,m), q = normalize(searchEl.value);
    const filtered = people.filter(p => normalize(p.name).includes(q));
    
    let html = "<tr><th class='nameHead'>Pessoa / SituaÃ§Ã£o</th>";
    const cols = [];
    for(let d=1; d<=days; d++){
      if(isSunday(y,m,d)){
        cols.push({d, t:"E", label:d, sub:"ED"}); cols.push({d, t:"C", label:d, sub:"Culto"});
      } else { cols.push({d, t:"C", label:d}); }
    }
    cols.forEach(c => html += `<th>${c.label}${c.sub?`<span class="sub">${c.sub}</span>`:""}</th>`);
    html += "</tr>";

    filtered.forEach(p => {
      const info = membrosInfo[p.name] || { sit: "Membro" };
      html += `<tr><td class="name">${p.name}<br><small style="color:blue">${info.sit}</small></td>`;
      cols.forEach(c => {
        const k = markKey(p.id, c.d, c.t), on = !!marks[k];
        html += `<td class="day ${on?"present":""}" data-pid="${p.id}" data-d="${c.d}" data-t="${c.t}">${on?"X":""}</td>`;
      });
      html += "</tr>";
    });
    table.innerHTML = html;
    
    table.querySelectorAll("td.day").forEach(td => {
      td.onclick = async () => {
        const pid = td.dataset.pid, d = td.dataset.d, t = td.dataset.t;
        const k = markKey(pid,d,t), fp = "marks." + k;
        await updateDoc(currentDocRef, { [fp]: marks[k] ? deleteField() : true });
      };
    });

    removePersonSelect.innerHTML = '<option value="">Selecione...</option>' + people.map(p => `<option value="${p.id}">${p.name}</option>`).join("");
    
    const currentDay = daySel.value;
    daySel.innerHTML = "";
    for(let d=1; d<=days; d++){
      const o = document.createElement("option");
      o.value = d; o.text = isSunday(y,m,d) ? `${d} (Dom)` : d;
      daySel.appendChild(o);
    }
    daySel.value = currentDay || now.getDate();
  }

  function generateWhatsApp(){
    const d = Number(daySel.value), y = yearSel.value, m = Number(monthSel.value);
    const sunday = isSunday(y, m, d);
    const format = (l) => l.length ? l.map((n, i) => `${i+1}. ${n}`).join("\n") : "NinguÃ©m marcado.";
    if(!sunday){
      const p = people.filter(x => marks[markKey(x.id,d,"C")]).map(x => x.name).sort();
      waText.value = `ðŸ“‹ G2 - PresenÃ§a (${d}/${m+1}/${y})\nTotal: ${p.length}\n\n${format(p)}`;
    } else {
      const e = people.filter(x => marks[markKey(x.id,d,"E")]).map(x => x.name).sort();
      const c = people.filter(x => marks[markKey(x.id,d,"C")]).map(x => x.name).sort();
      waText.value = `ðŸ“‹ G2 - PresenÃ§a (${d}/${m+1}/${y})\n\nðŸ“Œ EBD\nTotal: ${e.length}\n${format(e)}\n\nðŸ“Œ CULTO\nTotal: ${c.length}\n${format(c)}`;
    }
  }

  function generateMonthlyPDF() {
    const { jsPDF } = window.jspdf;
    const docPdf = new jsPDF({ unit: "pt", format: "a4", orientation: "landscape" });
    const y = Number(yearSel.value), m0 = Number(monthSel.value), days = daysInMonth(y, m0);
    
    docPdf.setFontSize(10); docPdf.setFont("helvetica", "bold");
    docPdf.text("IGREJA CRISTA MARANATA", 40, 30);
    docPdf.setFont("helvetica", "normal"); docPdf.text("Chamada do Grupo de AssistÃªncia", 40, 45);
    docPdf.text(`EmissÃ£o: ${new Date().toLocaleDateString("pt-BR")}`, 700, 30);
    docPdf.setFont("helvetica", "bold"); docPdf.text(`Grupo de AssistÃªncia: G2 - Romulo Peredo`, 40, 70);
    docPdf.text(`ReferÃªncia: ${months[m0]} / ${y}`, 700, 70);

    const head = ["Pessoa / SituaÃ§Ã£o", "Telefone"];
    for (let d = 1; d <= days; d++) head.push(isSunday(y, m0, d) ? `ED ${d}` : `${d}`);

    const body = people.map((p, i) => {
      const info = membrosInfo[p.name] || { sit: "Membro", tel: "" };
      const row = [ `${i+1}. ${p.name}\n(${info.sit})`, info.tel ];
      for (let d = 1; d <= days; d++) {
        if (isSunday(y, m0, d)) {
          const e = marks[markKey(p.id, d, "E")] ? "X" : "";
          const c = marks[markKey(p.id, d, "C")] ? "X" : "";
          row.push(`${e}\n${c}`);
        } else row.push(marks[markKey(p.id, d, "C")] ? "X" : "");
      }
      return row;
    });

    docPdf.autoTable({
      startY: 90, head: [head], body: body, theme: 'grid',
      styles: { fontSize: 7, cellPadding: 2, halign: 'center', valign: 'middle' },
      columnStyles: { 0: { halign: 'left', cellWidth: 140 }, 1: { cellWidth: 60 } },
      headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0] }
    });
    docPdf.save(`Relatorio_G2_${monthKey()}.pdf`);
  }

  async function attachListeners(){
    if(unsubscribePeople) unsubscribePeople();
    peopleDocRef = doc(db, "presencas_g2_meta", "people");
    unsubscribePeople = onSnapshot(peopleDocRef, snap => {
      if(snap.exists()) people = snap.data().people || [];
      render();
    });

    if(unsubscribeMonth) unsubscribeMonth();
    currentDocRef = doc(db, "presencas_g2", monthKey());
    await ensureDocExists(currentDocRef);
    unsubscribeMonth = onSnapshot(currentDocRef, snap => {
      if(snap.exists()) marks = snap.data().marks || {};
      render();
    });
  }

  (async ()=>{
    try {
      app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
      await signInAnonymously(auth);
      onAuthStateChanged(auth, user => {
        if(user) { setStatus("ok","Conectado","SincronizaÃ§Ã£o ativa."); attachListeners(); }
      });
    } catch(e) { setStatus("bad","Erro","Falha na conexÃ£o."); }
  })();

  document.getElementById("btnGenerate").onclick = generateWhatsApp;
  document.getElementById("btnCopy").onclick = () => { waText.select(); document.execCommand("copy"); alert("Copiado!"); };
  document.getElementById("btnPdf").onclick = generateMonthlyPDF;
  document.getElementById("btnClearDay").onclick = async () => {
    if(!confirm("Limpar dia atual?")) return;
    const d = daySel.value, patch = {};
    people.forEach(p => { patch[`marks.${p.id}-${d}-C`] = deleteField(); patch[`marks.${p.id}-${d}-E`] = deleteField(); });
    await updateDoc(currentDocRef, patch);
  };

  document.getElementById("btnAddPerson").onclick = async () => {
    const n = newPersonNameEl.value.trim().toUpperCase(); if(!n) return;
    const newList = [...people, { id: normalize(n) + "-" + Date.now(), name: n }].sort((a,b)=>a.name.localeCompare(b.name));
    await setDoc(peopleDocRef, { people: newList }, { merge: true });
    newPersonNameEl.value = "";
  };

  document.getElementById("btnRemovePerson").onclick = async () => {
    const id = removePersonSelect.value; if(!id || !confirm("Remover?")) return;
    await setDoc(peopleDocRef, { people: people.filter(p => p.id !== id) }, { merge: true });
  };

  monthSel.onchange = yearSel.onchange = () => attachListeners();
  searchEl.oninput = () => render();
</script>
</body>
</html>